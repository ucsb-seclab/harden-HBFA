## @file
# Azure Pipielines YML file that uses GitHub APIs to check if a PR against
# branch is from a submitter that is a member of the EDK II Maintainers team
# in the TianoCore organization on GitHub.
#
# * Generate a GitHub personal access token (PAT) from one of the organizations
#   team members from the developer 'Settings' -> 'Developer Settings' ->
#   'Personal Access Tokens' page.  Select 'Generate new token' and only enable
#   the single checkbox for admin:org/read:org scope.
#
# * Configure the Azure Pipeline Build with a Variable named 'GitHubPAT' seting
#   the value to the generated personal access token (PAT).  Configure the
#   'GitHubPAT' variable as 'Keep this value secret'.
#
# * Configure the Azure Pipeline Build 'Triggers' -> 'Pull request validation'
#   to enable both 'Build pull requests from forks of this repository' and
#   'Make secrets available to builds of forks'.
#
# NOTE: This example monitors pull requests against the edk2-ci branch.  Most
# environments would replace 'edk2-ci' with 'master'.
#
# NOTE: This example uses the team number 1649488 that is the EDK II Maintainers
# team in the TianoCore organization.  This value must be updated to test user
# membership in a different team.
#
# Copyright (c) 2019, Intel Corporation. All rights reserved.<BR>
# SPDX-License-Identifier: BSD-2-Clause-Patent
#
# https://developer.github.com/v3/teams/members/#get-team-membership
# https://github.com/tianocore
# https://github.com/orgs/tianocore/teams/edk-ii-maintainers
#
##

trigger: none

pr:
- edk2-ci

pool:
  vmImage: 'ubuntu-latest'

steps:
- checkout: none

- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.7.x'
    architecture: 'x64'

- script: pip install --user requests
  displayName: 'Install Python requests module'

- task: PythonScript@0
  displayName: 'Check EDK II Maintainers team membership'
  inputs:
    arguments: $(GitHubPAT) $(Build.Repository.Id) $(System.PullRequest.PullRequestNumber) 1649488
    scriptSource: inline
    script: |
      import sys
      import requests
      #
      # Check number of arguments
      #
      if len(sys.argv) < 5:
        print('CheckGitHubTeamMembership: Too few arguments.')
        print('Usage: CheckGitHubTeamMembership <Token> <RepoId> <PR#> <Team#>')
        sys.exit(1)
      #
      # Fill in Authorization token using Personal Access Token (PAT)
      #
      Headers = {
        'Authorization': 'token ' + sys.argv[1],
      }
      #
      # Generate GitHub API request for PR and parse user from JSON response
      #
      Url = 'https://api.github.com/repos/{RepoId}/pulls/{PrNumber}'.format(
              RepoId=sys.argv[2],
              PrNumber=sys.argv[3]
              )
      print(Url)
      PullRequest = requests.get(Url).json()
      if 'user' in PullRequest and 'login' in PullRequest['user']:
        User = PullRequest['user']['login']
      else:
        print('CheckGitHubTeamMembership: Invalid pull request number {PrNumber}.'
              .format(PrNumber=sys.argv[3]))
        sys.exit(1)
      #
      # Generate GitHub API request to check if user is a member of a team and
      # parse the JSON response
      #
      Url = 'https://api.github.com/teams/{Team}/memberships/{User}'.format(
              Team=sys.argv[4],
              User=User
              )
      print(Url)
      Membership = requests.get(Url, headers=Headers).json()
      #
      # If JSON response does not contain a 'state' or 'role' field, then exit with
      # an error.
      #
      if 'state' not in Membership or 'role' not in Membership:
        print('CheckGitHubTeamMembership: User {User} not found.'
              .format(User=User))
        sys.exit(1)
      #
      # If JSON response does not show the user as active, then exit with an error.
      #
      if Membership['state'] not in ['active']:
        print('CheckGitHubTeamMembership: User {User} is not active.'
              .format(User=User))
        sys.exit(1)
      #
      # If JSON response does not show the user with a role of member or maintainer,
      # then exit with an error
      #
      if Membership['role'] not in ['member', 'maintainer']:
        print('CheckGitHubTeamMembership: User {User} is not a member/maintainer.'
              .format(User=User))
        sys.exit(1)
      #
      # JSON response indicates that user is an active member/maintainer.  Exit
      # with success.
      #
      print('CheckGitHubTeamMembership: User {User} is active {Role}.'
          .format(User=User, Role=Membership['role']))
